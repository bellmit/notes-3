# 一、change buffer 的作用过程及适用场景

当更新一个数据页时，如果数据页在内存中就直接更新，如果数据页不在内存中的话，在不影响数据一致性的前提下，InnoDB将这些更新操作缓存在 change buffer 中，这样就不需要从磁盘中读入这个数据页了。在下次查询需要访问这个数据页的时候，将磁盘数据读入内存，然后执行 change buffer 中与这个数据页有关的操作，通过这种方式保证这个数据逻辑的正确性。

将 change buffer 应用到数据页的过程称为 merge，除了访问会触发 merge 外，系统有后台线程会定期 merge，数据库实例关闭时也会先执行 merge。

**1、什么情况下会使用 change buffer？**

对于唯一索引来说，所有的更新操纵都要判断这个操作是否违反唯一性约束。需要将数据页读入内存，进行判断，如果数据页已经在内存里了，那么这个更新操作会很快。

因此唯一索引不会使用 change buffer，只有普通索引可以使用。

**2、为什么普通索引适合使用 change buffer？**

在数据页在内存中的情况下，普通索引和唯一索引的执行效率几乎不大，唯一的区别就是判断一下唯一性，这种情况先不考虑。另外一种情况就是数据页不在内存中的时候，这时候普通索引只需要将更新记录在 change buffer 中，执行就结束了，避免了 IO 操作，对应的性能会有明显的提升。

因此：change buffer 比较适用于写多读少的场景，因为 merge 的时候是真正进行数据更新的时刻，而 change buffer 的主要目的就是将记录的变更动作缓存下来，所以在一个数据页做 merge 之前，change buffer 记录的变更越多（也就是这个页面上要更新的次数越多），收益就越大。

综述：change buffer 主要节省了随机读磁盘的 IO 消耗。

# 二、配置参数

change buffer 用的是 buffer pool 里的内存，因此不能无限增大。change buffer 的大小，可以通过参数 innodb_change_buffer_max_size 来动态设置。这个参数设置为 50 的时候，表示 change buffer 的大小最多只能占用 buffer pool 的 50%，这个参数的默认值是 25（MySQL5.7中）。

如果 innodb_change_buffer_max_size 设置为 0，则表示关闭 change buffer。

三、普通索引和唯一索引应该怎么选择？

优先选用普通索引，尽可能业务来保证唯一性，因为唯一索引的更新就不能使用 change buffer，实际上也只有普通索引可以使用。