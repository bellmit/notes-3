- [一、连接器](#一连接器)
- [二、分析器（要做什么）](#二分析器要做什么)
- [三、优化器（怎么做）](#三优化器怎么做)
- [四、执行器](#四执行器)

大体来说，MySQL可以分为**Server层**和**存储引擎层**两部分。

Server层包含连接器、分析器、优化器、执行器等，以及所有的内置函数，还包含所有跨引擎的功能，比如：存储过程、触发器、视图等。

存储引擎层负责数据的存储和获取。采用插件式的架构，支持InnoDB、MyISAM、Memory等存储引擎。

# 一、连接器

负责跟客户端建立连接、获取权限、维持和管理连接等。

使用命令`mysql -h$ip -u$user -p`连接到MySQL服务器上，执行完该命令，连接器就会收到连接请求，检查用户名密码、用户的权限。

如果客户端长时间没有操作，连接器就会自动断开连接，默认是8小时，由参数`wait_timeout`控制。

# 二、分析器（要做什么）

分析器的作用就是去分析你发送过来的SQL是要做什么。

1. 词法分析：识别SQL关键字、表名、列名等。
2. 语法分析：判断输入的SQL是否符合MySQL语法。

如果你的语句不对，就会收到“You have an error in your SQL syntax”的错误提醒。一般语法错误会提示第一个出现错误的位置，所以你要关注的是紧接“use near”的内容。

# 三、优化器（怎么做）

优化器作用就是去分析怎么做才是最优的。比如：使用哪个索引、多表关联的时候各个表的关联顺序。

tip：优化器有可能也会选择错索引的。

# 四、执行器

执行器会调用存储引擎的接口进行数据的获取，但是！在数据获取之前会校验权限（用户是否有这个表的权限）。

比如语句：`SELECT * FROM t WHERE id=10;`的执行过程如下：

1. 调用InnoDB引擎接口取这个表的第一行，判断id值是不是10，如果不是则跳过，如果是则将这行存在结果集中；
2. 调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行。
3. 执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。

至此，这个语句就执行完成了。

对于有索引的表，执行的逻辑也差不多。第一次调用的是“取满足条件的第一行”这个接口，之后循环取“满足条件的下一行”这个接口，这些接口都是引擎中已经定义好的。

你会在数据库的慢查询日志中看到一个`rows_examined`的字段，表示这个语句执行过程中扫描了多少行。这个值就是在执行器每次调用引擎获取数据行的时候累加的。

在有些场景下，执行器调用一次，在引擎内部则扫描了多行，因此引擎扫描行数跟`rows_examined`并不是完全相同的。
