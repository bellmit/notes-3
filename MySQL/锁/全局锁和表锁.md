- [一、全局锁](#一全局锁)
- [二、表级锁](#二表级锁)
    - [1、表锁](#1表锁)
    - [2、元数据锁](#2元数据锁)
- [三、如何安全的给小表加字段？](#三如何安全的给小表加字段)

# 一、全局锁

全局锁就是对整个数据库实例加锁。MySQL 提供了一个加全局读锁的方法，命令是 Flush tables with read lock (FTWRL)。当你需要让整个库处于只读状态的时候，可以使用这个命令，之后其他线程的以下语句会被阻塞：数据更新语句（数据的增删改）、数据定义语句（包括建表、修改表结构等）和更新类事务的提交语句。

全局锁的典型使用场景是，做全库逻辑备份。也就是把整库每个表都 select 出来存成文本。

全局锁的目的是为了拿到数据的一致性视图，使用 InnoDB 时，是不是也可以使用 MVCC 拿到一致性视图呢？没错，官方自带的逻辑备份工具是 mysqldump。当 mysqldump 使用参数 –single-transaction 的时候，导数据之前就会启动一个事务，来确保拿到一致性视图。而由于 MVCC 的支持，这个过程中数据是可以正常更新的。

但是！MVCC 只有 InnoDB 引擎支持，其它引擎就不支持了，而 FTWRL 是 Server 层面的，对所有引擎都适用。

为什么不使用`set global readonly=true`的方式呢？有两个原因：

1. 在一些系统中，readonly 被用来做其它逻辑，比如标识是否是从库。
2. 如果执行了 FTWRL 命令之后，客户端断开连接了，则 MySQL 会自动释放这个锁。而设置为 readonly 后，如果客户端断开连接，则数据库会一直处于 readonly 状态。

**加锁&解锁**

- 加锁：`flush tables with read lock;`
- 解锁：`unlock tables;`

# 二、表级锁

表级锁有两种：表锁、元数据锁(MDL)。

## 1、表锁

- 加锁：`lock tables ... read/write;`
- 解锁：`unlock tables;`

加锁后，客户端断开连接后会自动释放锁。

## 2、元数据锁

元数据锁是 MySQL 自动加锁解锁的，它的作用是保证读写的正确性。当对一个表做增删改查操作时，加 MDL 读锁，当要对表结构进行变更操作时，加 MDL 写锁。

- 读锁之间不互斥，因为可以有多个线程同时对一张表CRUD。
- 读与写之间、写与写之间是互斥的，以保证变更表结构操作的安全性，因此，如果有两个线程同时要给一个表加字段，其中一个要等另一个线程执行完才能开始执行。

# 三、如何安全的给小表加字段？

1. 首先要解决大事务，在加字段的时候查询一下是否有大事务正在执行。
2. 给 alter 语句加上超时时间。
